
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Users Collection
    // - Anyone can create a user document (signup).
    // - A user can only read or update their own document.
    // - Admins can read or update any user document.
    match /users/{userId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Listings Collection
    // - Approved listings can be read by anyone.
    // - Users can create listings.
    // - A user can update their own listing.
    // - Admins can perform any action on any listing.
    match /listings/{listingId} {
      allow read: if resource.data.status == 'approved' || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow create: if request.auth != null;
      allow update: if request.resource.data.ownerId == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Categories Collection
    // - Anyone can read the categories.
    // - Only admins can write to the categories collection.
    match /categories/{categoryId} {
        allow read: if true;
        allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Messages Collection
    // - Any authenticated user can create a message.
    // - Only admins can read or delete messages.
    match /messages/{messageId} {
      allow create: if request.auth != null;
      allow read, delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
